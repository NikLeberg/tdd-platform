name: CI

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    container: nikolodion/tdd-platform:latest
    strategy:
      matrix:
        include:
          - platform: linux
            bashEnvFile: ""
            runCommand: make monitor
            cache: ""
          - platform: esp32
            runCommand: ""
            cache: "/root/.espressif/esp-idf/components"
          - platform: esp8266
            runCommand: ""
            cache: "/root/.espressif/ESP8266_RTOS_SDK/components"
    env:
      BASH_ENV: ${{github.workspace}}/platform/${{matrix.platform}}/environment.sh
      # Fix: esp-idf-tool-detection defaults to ~/.espressif but ~ in github
      # runners points to '/github/home' instead of '/root'.
      # https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-guides/tools/idf-tools.html#tools-installation-directory
      IDF_TOOLS_PATH: /root/.espressif
    defaults:
      run:
        shell: bash

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive

    - name: üíæ Cache
      uses: actions/cache@v2
      with:
        path: |
          ~/.cache/ccache
          ${{matrix.cache}}
        key: ${{matrix.platform}}-cache

    - name: üìÅ Setup build folder
      run: mkdir -p build/${{matrix.platform}}

    - name: üõ† Generate
      working-directory: build/${{matrix.platform}}
      run: cmake ./../.. -DPLATFORM=${{matrix.platform}}

    - name: ‚öô Build
      working-directory: build/${{matrix.platform}}
      run: make all

    - name: ‚ñ∂ Run
      if: ${{matrix.runCommand != ''}}
      working-directory: build/${{matrix.platform}}
      run: ${{matrix.runCommand}}
