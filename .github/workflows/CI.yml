name: CI

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    container: nikolodion/tdd-platform:latest
    strategy:
      matrix:
        include:
          - platform: linux
            bashEnvFile: ""
            runCommand: ./src/tdd-platform
          - platform: esp32
            bashEnvFile: /root/.espressif/esp-idf/export.sh
            runCommand: ""
          - platform: esp8266
            bashEnvFile: /root/.espressif/ESP8266_RTOS_SDK/export.sh
            runCommand: ""
    env:
      BASH_ENV: ${{ matrix.bashEnvFile }}
    defaults:
      run:
        shell: bash

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive

    - name: üìÅ Setup build folder
      run: mkdir -p build/${{ matrix.platform }}

    - name: Setup tmate session
      with:
        sudo: false
      uses: mxschmitt/action-tmate@v3

    - name: üõ† Generate
      working-directory: build/${{ matrix.platform }}
      run: cmake ./../.. -DPLATFORM=${{ matrix.platform }}

    - name: ‚öô Build
      working-directory: build/${{ matrix.platform }}
      run: make all

    - name: ‚ñ∂ Run
      if: ${{ matrix.runCommand != '' }}
      working-directory: build/${{ matrix.platform }}
      run: ${{ matrix.runCommand }}
